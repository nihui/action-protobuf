name: release
on: push

jobs:
  pnnx:
    runs-on: ubuntu-20.04
    
    strategy:
      matrix:
        torch-version: [1.8.1, 1.9.1, 1.10.0]

    steps:
    - name: setup pytorch-${{ matrix.torch-version }}
      run: |
        pip install torch==${{ matrix.torch-version }}+cpu -f https://download.pytorch.org/whl/torch_stable.html

    - name: ncnn
      uses: actions/checkout@v2
      with:
        repository: nihui/ncnn
        path: ncnn
        ref: pnnx

    - name: build
      run: |
        cd ncnn/tools/pnnx
        mkdir build && cd build
        cmake -DTorch_INSTALL_DIR="$HOME/.local/lib/python3.8/site-packages/torch" ..
        cmake --build . -j 2
    - name: test
      run: |
        cd ncnn/tools/pnnx
        cd build && ctest --output-on-failure
